#include "ntc_thermistor.h"

// LUT (ADC value -> temperature multiplied by 10)
static const NTC_LUT_Entry_t ntc_lut[] = {
	{3732, 0},    // 0.0°C
	{3714, 10},   // 1.0°C
	{3695, 20},   // 2.0°C
	{3676, 30},   // 3.0°C
	{3656, 40},   // 4.0°C
	{3635, 50},   // 5.0°C
	{3614, 60},   // 6.0°C
	{3592, 70},   // 7.0°C
	{3569, 80},   // 8.0°C
	{3546, 90},   // 9.0°C
	{3522, 100},  // 10.0°C
	{3497, 110},  // 11.0°C
	{3471, 120},  // 12.0°C
	{3445, 130},  // 13.0°C
	{3418, 140},  // 14.0°C
	{3391, 150},  // 15.0°C
	{3362, 160},  // 16.0°C
	{3333, 170},  // 17.0°C
	{3304, 180},  // 18.0°C
	{3274, 190},  // 19.0°C
	{3243, 200},  // 20.0°C
	{3211, 210},  // 21.0°C
	{3179, 220},  // 22.0°C
	{3146, 230},  // 23.0°C
	{3113, 240},  // 24.0°C
	{3079, 250},  // 25.0°C
	{3045, 260},  // 26.0°C
	{3010, 270},  // 27.0°C
	{2974, 280},  // 28.0°C
	{2938, 290},  // 29.0°C
	{2902, 300},  // 30.0°C
	{2865, 310},  // 31.0°C
	{2828, 320},  // 32.0°C
	{2790, 330},  // 33.0°C
	{2752, 340},  // 34.0°C
	{2714, 350},  // 35.0°C
	{2676, 360},  // 36.0°C
	{2637, 370},  // 37.0°C
	{2598, 380},  // 38.0°C
	{2559, 390},  // 39.0°C
	{2520, 400},  // 40.0°C
	{2480, 410},  // 41.0°C
	{2441, 420},  // 42.0°C
	{2401, 430},  // 43.0°C
	{2362, 440},  // 44.0°C
	{2322, 450},  // 45.0°C
	{2283, 460},  // 46.0°C
	{2244, 470},  // 47.0°C
	{2204, 480},  // 48.0°C
	{2165, 490},  // 49.0°C
	{2126, 500},  // 50.0°C
	{2087, 510},  // 51.0°C
	{2049, 520},  // 52.0°C
	{2010, 530},  // 53.0°C
	{1972, 540},  // 54.0°C
	{1934, 550},  // 55.0°C
	{1897, 560},  // 56.0°C
	{1859, 570},  // 57.0°C
	{1823, 580},  // 58.0°C
	{1786, 590},  // 59.0°C
	{1750, 600},  // 60.0°C
	{1714, 610},  // 61.0°C
	{1679, 620},  // 62.0°C
	{1644, 630},  // 63.0°C
	{1610, 640},  // 64.0°C
	{1576, 650},  // 65.0°C
	{1542, 660},  // 66.0°C
	{1509, 670},  // 67.0°C
	{1477, 680},  // 68.0°C
	{1445, 690},  // 69.0°C
	{1413, 700},  // 70.0°C
	{1382, 710},  // 71.0°C
	{1352, 720},  // 72.0°C
	{1322, 730},  // 73.0°C
	{1292, 740},  // 74.0°C
	{1263, 750},  // 75.0°C
	{1235, 760},  // 76.0°C
	{1207, 770},  // 77.0°C
	{1180, 780},  // 78.0°C
	{1153, 790},  // 79.0°C
	{1127, 800},  // 80.0°C
	{1101, 810},  // 81.0°C
	{1076, 820},  // 82.0°C
	{1051, 830},  // 83.0°C
	{1027, 840},  // 84.0°C
	{1003, 850},  // 85.0°C
	{980,  860},  // 86.0°C
	{957,  870},  // 87.0°C
	{935,  880},  // 88.0°C
	{913,  890},  // 89.0°C
	{892,  900},  // 90.0°C
	{871,  910},  // 91.0°C
	{851,  920},  // 92.0°C
	{831,  930},  // 93.0°C
	{811,  940},  // 94.0°C
	{792,  950},  // 95.0°C
	{774,  960},  // 96.0°C
	{756,  970},  // 97.0°C
	{738,  980},  // 98.0°C
	{721,  990},  // 99.0°C
	{704,  1000}  // 100.0°C
};


#define LUT_SIZE (sizeof(ntc_lut) / sizeof(ntc_lut[0]))

float NTC_GetTemperature(uint16_t adc_value) {
	if (adc_value >= (uint16_t)ADC_MAX_VALUE - 10) return 150.0f; // Error: open circuit
	if (adc_value <= 10) return -50.0f; // Error: short circuit

	if (adc_value > ntc_lut[0].adc_value) {
		return (float)ntc_lut[0].temp_x10 / 10.0f;
	}
	if (adc_value < ntc_lut[LUT_SIZE - 1].adc_value) {
		return (float)ntc_lut[LUT_SIZE - 1].temp_x10 / 10.0f;
	}

    // Looking for neighboring values
	for (uint16_t i = 0; i < LUT_SIZE - 1; i++) {
		if (adc_value >= ntc_lut[i + 1].adc_value && adc_value <= ntc_lut[i].adc_value) {
			uint16_t adc_high = ntc_lut[i].adc_value;
			uint16_t adc_low = ntc_lut[i + 1].adc_value;
			int16_t temp_high = ntc_lut[i].temp_x10;
			int16_t temp_low = ntc_lut[i + 1].temp_x10;

			float ratio = (float)(adc_value - adc_low) / (float)(adc_high - adc_low);
			float temp_interpolated = temp_low + ratio * (temp_high - temp_low);

			return temp_interpolated / 10.0f;
        }
    }

    // Should never actually reach here (at least i hope so)
	return 0.0f;
}
